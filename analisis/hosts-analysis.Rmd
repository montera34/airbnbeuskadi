---
title: "Efecto Airbnb en Donostia: hosts"
output: html_document
---

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
# Este documento en Rmarkdown está pensado para producir un informe a partir de datos de Airbnb de datahippo. Para datos de InsideAirbnb mira en https://github.com/montera34/airbnb.barcelona/tree/master/analisis/preanalisis-airbnb.Rmd
# Estos scripts producen una serie de gráficos sobre los hosts (anfitriones), distribución y concentración en una determinada ciudad.

# Selecciona variables de configuración
# región/lugar, fechas a analizar...
local_activo_name <- "Donostia" #cambia 'Zarautz' por el municipio que quieras analizar
fecha <- "2018-09-26" # date last scraping
# Donostia
coord_x <- c(-2.02, -1.96)
coord_y <- c(43.30,43.33)
# Euskadi
# coord_x <- c(-3.5, -1.75)
# coord_y <- c(42.4,43.5)
# Bilbao
# coord_x <- c(-2.98, -2.9)
# coord_y <- c(43.24,43.28)
desde <- "2018-03-01" # fecha desde la cual se filtran los que tienen su fecha "revised" posterior
caption_1 <- "Datos: datahippo.org (2018-09-26). Gráfico: lab.montera34.com/airbnb"
caption_2 <- paste("Datos: datahippo.org activos desde ", desde ,". Info: lab.montera34.com", sep = "")


# Instala y carga librerías ----
library(tidyverse)
library(knitr,quietly=T)
library(kableExtra)
library(reshape2) # for melt
# library(ggplot2) #ya incluido en tidyverse
# library(dplyr) #ya incluido en tidyverse
# for maps and theme nothing
library(ggmap)
# read geojson
library(rgdal)


# Carga datos -----
# introduce el path de tu archivo listings. Necesitas desactivar Quotes, porque el texto incluye \"
# local_activo <- read.delim("../data/original/airbnb/180911/listings_barcelona_insideairbnb.csv",sep = ",")
local_activo <- read.delim("../data/original/donostia/datahippo/180926/listings-airbnb_donostia_datahippo.csv",sep = ",")
# local_activo <- read.delim("../data/original/euskadi/datahippo/180926/listings-airbnb_euskadi_datahippo.csv",sep = ",")
# local_activo <- read.delim("../data/original/bilbao/datahippo/180926/listings-airbnb_bilbao_datahippo.csv",sep = ",")

# Parse dates
local_activo$found_date <- as.Date(as.POSIXct(local_activo$found))
local_activo$revised_date <- as.Date(as.POSIXct(local_activo$revised))
attach(local_activo)

# shapes
# Load shapes
barrios <- readOGR("../data/barrios-donostia_simplificado.geojson")
menores <- readOGR("../data/output/limites/unidades-menores-donostia_cleaned-merged.geojson")
mar <- readOGR("../data/original/shapes/mar-donostia.geojson")

# Define paleta de color
# palette1 <- c("#2171b5","#6baed6","#bdd7e7","#fee5d9")
palette1 <- c("#4292c6","#6baed6","#9ecae1","#fee5d9")
```

Este informe se ha generado automáticamente con R a partir del [script de Rmarkdown](https://github.com/montera34/airbneuskadi/tree/master/analisis/hosts-analysis.Rmd) disponible en el [repositorio airbnbeuskadi](https://github.com/montera34/airbneuskadi).

## Datos

+ Datahippo.com `r local_activo_name`
+ Fecha scraping: `r fecha`

## Resumen

En **`r local_activo_name`** se han publicado `r format(nrow(local_activo), big.mark='.')` anuncios de Airbnb desde que Datahippo guarda registro, que han tenido capacidad para `r format(sum(na.omit(local_activo$capacity)), big.mark='.') ` plazas (accommodates). 

De esos anuncios `r format(nrow(local_activo[!(local_activo$license==""),]), big.mark='.')` tienen rellena la parte de la licencia  (lo que supone un `r format(round(100*nrow(local_activo[!(local_activo$license==""),])/nrow(local_activo), 1), nsmall = 1, decimal.mark=',')`% del municipio), lo que no quiere decir que todas esas licencias indicadas sean válidas.

Estos anuncios (listings, en la terminología de Airbnb) han sido publicados por `r format(length(unique(local_activo$host.id)), big.mark='.')` anfitriones. 

PERO

De esos `r format(nrow(local_activo), big.mark='.')` anuncios han sido "encontrados" como disponibles por el scraping de Datahippo con fecha posterior (ver siguiente tabla):

| fecha | nº anuncios encontrados | % respecto total |
| ----- | ----------------------- | ---------------- |
| 2017-09-01 | `r format(nrow(local_activo[revised_date > "2017-09-01",]), big.mark='.')` |  `r format(round(100* nrow(local_activo[revised_date > "2017-09-01",])/nrow(local_activo), 1 ), decimal.mark='.')` |
| 2017-10-01 | `r format(nrow(local_activo[revised_date > "2017-10-01",]), big.mark='.')` |  `r format(round(100* nrow(local_activo[revised_date > "2017-10-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2017-11-01 | `r format(nrow(local_activo[revised_date > "2017-11-01",]), big.mark='.')` |  `r format(round(100* nrow(local_activo[revised_date > "2017-11-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2017-12-01 | `r format(nrow(local_activo[revised_date > "2017-12-01",]), big.mark='.')` |  `r format(round(100* nrow(local_activo[revised_date > "2017-12-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2018-01-01 | `r format(nrow(local_activo[revised_date > "2018-01-01",]), big.mark='.')` |  `r format(round(100* nrow(local_activo[revised_date > "2018-01-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2018-02-01 | `r format(nrow(local_activo[revised_date > "2018-02-01",]), big.mark='.')` | |
| 2018-03-01 | `r format(nrow(local_activo[revised_date > "2018-03-01",]), big.mark='.')` | |
| 2018-04-01 | `r format(nrow(local_activo[revised_date > "2018-04-01",]), big.mark='.')` | |
| 2018-05-01 | `r format(nrow(local_activo[revised_date > "2018-05-01",]), big.mark='.')` | `r format(round(100* nrow(local_activo[revised_date > "2018-05-01",])/nrow(local_activo), 1 ), decimal.mark=',')`|
| 2018-06-01 | `r format(nrow(local_activo[revised_date > "2018-06-01",]), big.mark='.')` |`r format(round(100* nrow(local_activo[revised_date > "2018-06-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2018-07-01 | `r format(nrow(local_activo[revised_date > "2018-07-01",]), big.mark='.')` | `r format(round(100* nrow(local_activo[revised_date > "2018-07-01",])/nrow(local_activo), 1 ), decimal.mark=',')` |
| 2018-08-01 | `r format(nrow(local_activo[revised_date > "2018-08-01",]), big.mark='.')` | |
| 2018-09-01 | `r format(nrow(local_activo[revised_date > "2018-09-01",]), big.mark='.')` | |
| 2018-09-15 | `r format(nrow(local_activo[revised_date > "2018-09-15",]), big.mark='.')` | `r format(round(100* nrow(local_activo[revised_date > "2018-09-15",])/nrow(local_activo), 1 ), decimal.mark=',')`|
| 2018-09-20 | `r format(nrow(local_activo[revised_date > "2018-09-20",]), big.mark='.')` | `r format(round(100* nrow(local_activo[revised_date > "2018-09-20",])/nrow(local_activo), 1 ), decimal.mark=',')`|

```{r reviseddates, echo = FALSE, warning=FALSE, message=FALSE}
# calculate frequency of listings in revised dates
reviseddates <- as.data.frame(table(local_activo$revised_date))
colnames(reviseddates) <- c("dates","count")
reviseddates <- reviseddates[order(reviseddates$dates),]
reviseddates$dates <- as.Date(reviseddates$dates)
```

Es interesante repasar en qué fechas el scraper de datahippo.org revisó (campo "revised") los anuncios, esto es, volvió a guardar la información porque los consideró activso (hay `r length(unique(local_activo$revised_date))` fechas distintas de "revised"). En la siguiente lista se indican las fechas y el número de anuncios con esa fecha:
`r reviseddates`

```{r reviseddates_plot, echo = FALSE, warning=FALSE, message=FALSE}
# plot(reviseddates)

reviseddates$t <- 1

ggplot(reviseddates, aes(dates, t)) +
  geom_point(aes(size = count),alpha=0.3 ) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text.y = element_blank(),
  # axis.text = element_blank(),
  panel.background = element_rect(fill="#FFFFFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(title=paste("Cantidad y fechas de anuncios en ", local_activo_name ," con 'revised'", sept=""),
     subtitle = "Fechas en las que hubo seguro scraping",
     caption = caption_1)  
```

```{r filter, echo = FALSE, warning=FALSE, message=FALSE}
# Create filtered by date listings
local_activo_f <- local_activo[revised_date > desde,]
```

```{r map_1, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = mar,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="lightblue", size = 0.1) +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.3) +
geom_point(data= local_activo,
         aes(x=longitude, y=latitude, color=room_type),alpha=0.7,size = 0.7) + 
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(title=paste("Histórico de anuncios en ", local_activo_name, ".", sep = ""),
     subtitle = "Datos: Datahippo.org 2018-09-26",
     caption = caption_1)  +
guides(colour = guide_legend(override.aes = list(size=3))) 
```


```{r map_2, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = mar,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="lightblue", size = 0.1) +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.3) +
geom_point(
           # data= local_activo[revised_date > "2018-03-01",],
           data = local_activo_f,
         aes(x=longitude, y=latitude, color=room_type),alpha=0.7,size = 0.7) + 
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(title=paste("Anuncios que han estado disponibles (", nrow(local_activo_f) , ") desde ", desde ," en ", local_activo_name, sep = ""),
     caption = caption_2 )  +
guides(colour = guide_legend(override.aes = list(size=3))) 
```

### Los anfitriones con más alojamientos

Calculado por anuncios activos desde `r desde`.

```{r table_propietarios, echo = FALSE, warning=FALSE, eval=TRUE}
# propietarios <- table(local_activo$host_id) #crea tabla con frecuencias (count) de anfitriones (host_id) con anuncios
n_alojamientos <- local_activo_f %>% group_by(host.id) %>% summarize(alojamientos = n(),plazas = sum(capacity) ) %>% arrange(desc(alojamientos))

n_alojamientos <- data.frame(n_alojamientos) # crea data frame

kable(n_alojamientos[1:25,],caption = "Los 25 anfitriones con más alojamientos")
# propietarios_nalojamientos[1:30,]
# nalojamientos <- donostia %>%
#   group_by(host_id) %>%
#   summarize(sum.alojamientos=count(requires_license)) %>%
# arrange(desc(sum.alojamientos))
# kable(nalojamientos[1:20,],caption = "Los 30 anfitriones con más alojamientos (id)")

ggplot(data = n_alojamientos[1:25,] ,aes(x = reorder(host.id,alojamientos), y = alojamientos)) +
  geom_col() +
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.y = element_blank(), panel.grid.major.y = element_blank(),
    legend.position = "bottom",
    plot.caption=element_text(size=9)
  ) +
  labs(title = "Número de alojamientos por anfitrión: top 25",
       subtitle = "Septiembre 2018.",
       y = "número de anuncios",
       x = "anfitriones",
       caption = caption_2) +
  coord_flip()
```

#### En el mapa

##### Top 5

```{r anfitriones_map_1, echo = FALSE, warning=FALSE, eval=TRUE}
# converts host_id to factor to be able to colour by it
local_activo_f$host.id <- as.factor(local_activo_f$host.id)

ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[1:5,]$host.id,],
         aes(x=longitude, y=latitude, color=host.id),alpha=0.8,size = 1) + #color="blue"
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(title=paste("Cada punto es un alojamiento de los top 5 anfitriones según alojamientos", sep = ""),
     caption = caption_2)  +
guides(colour = guide_legend(override.aes = list(size=3))) 
```

```{r anfitriones_map_top1, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[1,]$host.id,],
         aes(x=longitude, y=latitude, color=room_type),alpha=0.8,size = 1) + #color="blue"
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(
  title=paste("Cada punto es un alojamiento del top 1 de anfitriones según alojamientos", sep = ""),
  subtitle = paste(nrow(local_activo[host.id %in% n_alojamientos[1,]$host.id,]),
                   " alojamientos en ", local_activo_name,  sep = ""),
  caption = caption_2
  ) +
  guides(colour = guide_legend(override.aes = list(size=3))) 
```

```{r anfitriones_map_top2, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[2,]$host.id,],
         aes(x=longitude, y=latitude, color=room_type),alpha=0.8,size = 1) + #color="blue"
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(
  title=paste("Cada punto es un alojamiento del top 2 de anfitriones según alojamientos", sep = ""),
  subtitle = paste(nrow(local_activo[host.id %in% n_alojamientos[2,]$host.id,]),
                   " alojamientos en ", local_activo_name,  sep = ""),
  caption = caption_2
  ) +guides(colour = guide_legend(override.aes = list(size=3))) 
```

```{r anfitriones_map_top3, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[3,]$host.id,],
         aes(x=longitude, y=latitude, color=room_type),alpha=0.8,size = 1) +
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(
  title=paste("Cada punto es un alojamiento del top 3 de anfitriones según alojamientos", sep = ""),
  subtitle = paste(nrow(local_activo[host.id %in% n_alojamientos[3,]$host.id,]),
                   " alojamientos en ", local_activo_name,  sep = ""),
  caption = caption_2
  ) +guides(colour = guide_legend(override.aes = list(size=3))) 
```

```{r anfitriones_map_top4, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[4,]$host.id,],
         aes(x=longitude, y=latitude, color=room_type),alpha=0.8,size = 1) +
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(
  title=paste("Cada punto es un alojamiento del top 4 de anfitriones según alojamientos", sep = ""),
  subtitle = paste(nrow(local_activo[host.id %in% n_alojamientos[4,]$host.id,]),
                   " alojamientos en ", local_activo_name,  sep = ""),
  caption = caption_2
  ) +
guides(colour = guide_legend(override.aes = list(size=3))) 
```

```{r anfitriones_map_top5, echo = FALSE, warning=FALSE, eval=TRUE}
ggplot() +
geom_polygon(data = barrios,
             aes(x = long, y = lat, group = group),
             color = "grey", fill="white", size = 0.1) +
geom_point(data= local_activo_f,
           aes(x=longitude, y=latitude),alpha=0.07,size = 0.3)+
geom_point(data= local_activo_f[local_activo_f$host.id %in% n_alojamientos[5,]$host.id,],
         aes(x=longitude, y=latitude, color=room_type),alpha=0.8,size = 1) +
coord_quickmap(xlim=coord_x, ylim=coord_y)  +
theme_nothing(legend = TRUE) +
theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
theme(
  panel.grid = element_blank(),
  axis.title = element_blank(),
  axis.text = element_blank(),
  panel.background = element_rect(fill="#EEEEFF",color = "grey",size = 0.25),
  legend.position = "top",
  plot.caption=element_text(size=9)
) +
labs(
  title=paste("Cada punto es un alojamiento del top 5 de anfitriones según alojamientos", sep = ""),
  subtitle = paste(nrow(local_activo[host.id %in% n_alojamientos[5,]$host.id,]),
                   " alojamientos en ", local_activo_name,  sep = ""),
  caption = caption_2
  ) +
guides(colour = guide_legend(override.aes = list(size=3))) 
```

### Distribución de número de plazas por usuario

```{r table_anfitriones_distribucion, echo = FALSE, warning=FALSE,, eval=TRUE}
ggplot(data=n_alojamientos, aes(alojamientos)) + 
  geom_histogram(breaks=seq(0, 190, by = 1)) + 
  # ylim(0,150) +
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
    legend.position = "bottom",
      plot.caption=element_text(size=9)
  ) +
  labs(title="Histograma de número de alojamientos por usuario",
       subtitle = "Septiembre 2018.",
        x="número de alojamientos por anfitrión", 
        y="número de propoietarios",
   caption = caption_2) 

# res <- hist(n_alojamientos$alojamientos)

``` 

### Los anfitriones con más plazas

```{r table_anfitriones_2, echo = FALSE, warning=FALSE,, eval=TRUE}

naccommodates <- group_by(local_activo_f, host.id) %>% summarise( plazas = sum(capacity),alojamientos = n() ) %>%  arrange(desc(plazas))
 
# naccommodates[1:30,]
kable(naccommodates[1:30,],caption = "Los 30 anfitriones con más plazas")

ggplot(naccommodates) +
  geom_bar(stat='identity', aes(x = reorder(host.id,plazas), y = plazas)) + coord_flip() + theme(axis.text.y = element_blank()) + 
  labs(x = "anfitriones", y = "nº anuncios", title= "Número de plazas por anfitrión" ) 
# + scale_y_continuous(breaks=seq(0,300,10))

# ggplot(naccommodates[1:25,] ) +
#   geom_bar(stat='identity', aes(x = reorder(host_id,plazas), y = plazas)) + coord_flip() + theme(axis.text.y = element_blank()) + 
#   labs(x = "anfitriones", y = "nº anuncios", title= "número de plazas por anfitrión top 30" ) 

ggplot(data = naccommodates[1:25,] ,aes(x = reorder(host.id,plazas), y = plazas)) +
  geom_col() +
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.y = element_blank(), panel.grid.major.y = element_blank(),
    legend.position = "bottom"
  ) +
  labs(title = "Número de plazas por usuario: top 25",
       subtitle = "Septiembre 2018.",
       y = "número de plazas",
       x = "anfitriones",
       caption = caption_2) +
  coord_flip()
```


### Distribución de número de plazas por anfitriones

```{r table_anfitriones_distribucion_2, echo = FALSE, warning=FALSE,, eval=TRUE}
ggplot(data=naccommodates, aes(plazas)) + 
  geom_histogram(breaks=seq(0, 1000, by = 1)) + 
  # ylim(c(0,7000))+
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
    legend.position = "bottom",
      plot.caption=element_text(size=9)
  ) +
  labs(
    title="Histograma de plazas por usuario",
    subtitle="Usuarios (cajones de 1). Septiembre 2018.",
    y="número de plazas", 
    x="número de plazas por usuario",
   caption = caption_2)

ggplot(data=naccommodates, aes(plazas)) + 
  geom_histogram(breaks=seq(0, 30, by = 1)) + 
  # ylim(c(0,500))+
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
    legend.position = "bottom"
  ) +
  labs(
    title="Histograma de plazas por usuario",
    subtitle="Usuarios con 30 plazas o menos (cajones de 1). Septiembre 2018.",
    y="número de plazas", 
    x="número de plazas por usuario",
   caption = caption_2)

ggplot(data=naccommodates, aes(plazas)) + 
  geom_histogram(breaks=seq(30, 1100, by = 10)) + 
  xlim(30,1100)+
  # ylim(0,20)+
  theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
  theme(
    panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank(),
    legend.position = "bottom"
  ) +
  labs(
    title="Histograma de plazas por usuario",
    subtitle="Usuarios con 30 plazas o más (cajones de 10). Septiembre 2018.",
    y="número de plazas", 
    x="número de plazas por usuario",
   caption = caption_2)

``` 

```{r final_output_distribucion_1, echo = FALSE, warning=FALSE,, eval=TRUE}
distribucion <- data.frame(matrix(0, ncol = 4, nrow = 3))
names(distribucion) <- c("mas_de_5","n3.4","n2","n1")
rownames(distribucion) <- c("anfitriones","alojamientos","plazas")

# Calcul acuantos anfitriones tienen n alojamientos
distribucion$n1[1] <- nrow(n_alojamientos[n_alojamientos$alojamientos == 1,])
distribucion$n2[1] <- nrow(n_alojamientos[n_alojamientos$alojamientos == 2,])
distribucion$n3.4[1] <- nrow(n_alojamientos[(n_alojamientos$alojamientos == 3 |n_alojamientos$alojamientos == 4) ,])
distribucion$mas_de_5[1] <- nrow(n_alojamientos[n_alojamientos$alojamientos >4,])

# Calcula cuantos alojamientos en total tienen los anfitriones con n alojamientos
distribucion$n1[2] <- sum(n_alojamientos[n_alojamientos$alojamientos == 1,"alojamientos"])
distribucion$n2[2] <- sum(n_alojamientos[n_alojamientos$alojamientos == 2,"alojamientos"])
distribucion$n3.4[2] <- sum(n_alojamientos[(n_alojamientos$alojamientos == 3 |n_alojamientos$alojamientos == 4),"alojamientos"])
distribucion$mas_de_5[2] <- sum(n_alojamientos[n_alojamientos$alojamientos >4,"alojamientos"])

# length(unique(local_activo$id))
# sum(distribucion[2,])

# Calcula cuantas plazas en total tienen los anfitriones con n alojamientos
distribucion$n1[3] <- sum(naccommodates[naccommodates$host.id %in% n_alojamientos[n_alojamientos$alojamientos == 1,]$host.id,]$plazas)
distribucion$n2[3] <- sum(naccommodates[naccommodates$host.id %in% n_alojamientos[n_alojamientos$alojamientos == 2,]$host.id,]$plazas)
distribucion$n3.4[3] <- sum(naccommodates[naccommodates$host.id %in% n_alojamientos[(n_alojamientos$alojamientos == 3 | n_alojamientos$alojamientos == 4),]$host.id,]$plazas)
distribucion$mas_de_5[3] <- sum(naccommodates[naccommodates$host.id %in% n_alojamientos[n_alojamientos$alojamientos > 4,]$host.id,]$plazas)

# Plot result in stacked bar chart
# Add tipo as column
distribucion$tipo <- rownames(distribucion)

# Una forma de hacerlo
# library(lattice)
# barchart(n1+n2+n3.4~variable,data=distribucion)

# Una forma de hacerlo
# library(reshape2)
dist.melt <- melt(distribucion,id.vars = "tipo")
dist.melt$tipo <- as.factor(dist.melt$tipo)
# Reorder levels for plot
dist.melt$tipo <- factor(dist.melt$tipo, levels =c("anfitriones","alojamientos","plazas"))

ggplot(dist.melt, aes(x = tipo, y = value,fill=variable)) +
    geom_bar(stat='identity') + # add position = "fill" to make 100% bars 
    scale_fill_manual(labels = c("Más de 5 anuncios", "3 o 4 anuncios", "2 anuncios", "1 anuncio"),values=palette1) +
    theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
    theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(), 
      panel.grid.major.x = element_blank(),
      plot.caption=element_text(size=9)
    ) +
    labs(title = paste("Concentración de la oferta de Airbnb en ", local_activo_name, sep = ""),
         subtitle = "Anfitriones, alojamientos y plazas",
         y = "cantidad",
         x = NULL,
         caption = caption_2,
          fill = "Nº de anuncios por anfitrión") +
  geom_text(data = dist.melt[dist.melt$value > 100,], aes(label =  format(value, big.mark="."), group=variable),
              position = position_stack(vjust = 0.5), hjust = 0.4,
              size=3,color="#000000")
    
# ggplot(dist.melt, aes(x = tipo, y = value,fill=variable)) +
#     geom_bar(stat='identity',position = "fill") # add  to make 100% bars
```

```{r final_output_distribucion_2, echo = FALSE, warning=FALSE,, eval=TRUE}

distribucion_per <- distribucion
# Anfitriones
distribucion_per[1,1:4] <- round(distribucion[1,1:4] / sum(distribucion[1,1:4]) * 100,1)
# Alojamientos
distribucion_per[2,1:4] <- round(distribucion[2,1:4] / sum(distribucion[2,1:4]) * 100,1)
# plazas
distribucion_per[3,1:4] <- round(distribucion[3,1:4] / sum(distribucion[3,1:4]) * 100,1)

# Una forma de hacerlo
dist_per.melt <- melt(distribucion_per,id.vars = "tipo")
dist_per.melt$tipo <- as.factor(dist_per.melt$tipo)
# Reorder levels for plot
dist_per.melt$tipo <- factor(dist_per.melt$tipo, levels =c("anfitriones","alojamientos","plazas"))

# ggplot(dist_per.melt, aes(x = tipo, y = value,fill=variable)) +
#     geom_bar(stat='identity') # add position = "fill" to make 100% bars

ggplot(dist_per.melt, aes(x = tipo, y = value,fill=variable)) +
    geom_bar(stat='identity') + # add position = "fill" to make 100% bars 
    scale_fill_manual(labels = c("Más de 5 anuncios", "3 o 4 anuncios", "2 anuncios", "1 anuncio"),values=palette1) +
    theme_minimal(base_family = "Roboto Condensed", base_size = 14) +
    theme(
      panel.grid.minor.x = element_blank(),
      panel.grid.minor.y = element_blank(), 
      panel.grid.major.x = element_blank(),
      plot.caption=element_text(size=9)
    ) +
    labs(title = paste("Concentración de la oferta de Airbnb en ", local_activo_name, sep = ""),
         subtitle = "Anfitriones, alojamientos y plazas",
         y = "porcentaje",
         x = NULL,
         caption = caption_2,
         fill = "Nº de anuncios por anfitrión") +
  geom_text(data = dist_per.melt, aes(label =  format(value, nsmall = 1, decimal.mark=','), group=variable),
              position = position_stack(vjust = 0.5), hjust = 0.4,
              size=3,color="#000000")

```

```{r table_anfitriones_2b, echo = FALSE, warning=FALSE,, eval=TRUE}
# calculates basic numbers
n_hosts <- length(unique(local_activo_f$host.id))
n_acommodates <- sum(local_activo_f$capacity)
```

### Resumen

Calculado por anuncios activos desde `r desde`.

Los 10 primeros anfitriones (`r format(round(100*10/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:10,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:10,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 20 primeros anfitriones (`r format(round(100*20/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:20,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:20,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 50 primeros anfitriones (`r format(round(100*50/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:50,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:50,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 100 primeros anfitriones (`r format(round(100*100/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:100,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:100,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 200 primeros anfitriones (`r format(round(100*200/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:200,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:200,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 300 primeros anfitriones (`r format(round(100*300/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:300,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:300,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

Los 500 primeros anfitriones (`r format(round(100*500/n_hosts, 1), nsmall = 1)`% del total de anfitriones) con más plazas tienen `r sum(naccommodates[1:500,3])` plazas disponibles (que son el `r format(round(100*sum(naccommodates[1:500,3])/n_acommodates, 1), nsmall = 1)`% del total de plazas).

## Licencias

Datahippo no dispone de datos de licencias insertas en anuncios de Airbnb.